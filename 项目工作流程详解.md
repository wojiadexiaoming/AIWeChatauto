
# 微信公众号AI发布系统 - 详细工作流程

## 1. 系统启动流程

### 1.1 应用初始化
```
main.py (启动入口)
    ↓
app_new.py (Flask应用创建)
    ↓
初始化各个服务实例
    ├── ConfigService (配置服务)
    ├── WeChatService (微信服务)
    ├── GeminiService (AI服务)
    ├── ImageService (图像服务)
    └── DraftService (草稿服务)
    ↓
注册控制器路由
    ├── ConfigController (/api/config, /api/test-wechat, /api/test-gemini)
    └── ArticleController (/api/generate-article)
    ↓
启动Flask Web服务器 (0.0.0.0:5000)
```

### 1.2 目录结构创建
```
应用启动时自动创建必要目录：
├── logs/ (日志存储)
├── cache/ (临时文件缓存)
└── 验证config.json存在性
```

## 2. 用户配置流程

### 2.1 前端页面加载
```
用户访问 / 
    ↓
Flask返回 templates/index.html
    ↓
浏览器加载静态资源
    ├── static/css/layout.css (布局样式)
    ├── static/css/components.css (组件样式)
    └── static/js/app.js (前端逻辑)
    ↓
JavaScript执行初始化
    ├── 加载现有配置 (GET /api/config)
    ├── 初始化事件监听器
    └── 显示配置界面
```

### 2.2 配置保存流程
```
用户填写配置信息
    ├── 微信公众号 AppID
    ├── 微信公众号 AppSecret
    ├── Gemini API密钥
    ├── AI模型选择 (默认: gemini-2.5-flash)
    ├── 文章作者
    └── 内容源URL
    ↓
前端验证输入完整性
    ↓
发送 POST /api/config 请求
    ↓
ConfigController.save_config()
    ├── 接收请求数据
    ├── 数据验证
    ├── 调用 ConfigService.save_config()
    ├── 写入 config.json 文件
    ├── 添加时间戳 (created_at, updated_at)
    └── 返回保存结果
    ↓
前端显示保存结果提示
```

### 2.3 连接测试流程

#### 微信连接测试
```
用户点击"测试微信连接"
    ↓
前端发送 POST /api/test-wechat
    ↓
ConfigController.test_wechat()
    ├── 获取微信配置信息
    ├── 验证 AppID 和 AppSecret 存在
    ├── 调用 WeChatService.get_access_token()
    │   ├── 构造微信API请求URL
    │   ├── 发送 GET 请求到微信服务器
    │   ├── 解析返回的access_token
    │   └── 验证token有效性
    ├── 返回测试结果
    └── 记录调试信息
```

#### Gemini AI连接测试
```
用户点击"测试Gemini连接"
    ↓
前端发送 POST /api/test-gemini
    ↓
ConfigController.test_gemini()
    ├── 获取Gemini配置信息
    ├── 验证API密钥存在
    ├── 调用 GeminiService.test_connection()
    │   ├── 设置Google GenAI客户端
    │   ├── 发送简单测试提示词
    │   ├── 验证API响应
    │   └── 返回测试结果
    ├── 返回连接状态
    └── 记录响应信息
```

## 3. 文章生成完整流程

### 3.1 文章生成请求初始化
```
用户输入文章标题
    ↓
前端验证标题非空
    ↓
显示生成进度界面
    ↓
发送 POST /api/generate-article {"title": "用户输入的标题"}
    ↓
ArticleController.generate_article() 开始处理
```

### 3.2 配置验证阶段
```
ArticleController.generate_article()
    ↓
验证微信配置
    ├── 检查 wechat_appid 存在
    ├── 检查 wechat_appsecret 存在
    └── 如果缺失，返回错误信息
    ↓
验证Gemini配置
    ├── 检查 gemini_api_key 存在
    ├── 设置GeminiService的API密钥
    └── 如果缺失，返回错误信息
```

### 3.3 AI内容生成阶段
```
第一步：生成文章主体内容
    ↓
GeminiService.generate_article_content(title, model)
    ├── 构造详细的内容生成提示词
    │   ├── 要求：专业性、可读性、结构化
    │   ├── 格式：HTML格式，包含标题、段落、列表
    │   └── 长度：1500-2500字
    ├── 调用Google Gemini API
    ├── 处理API响应
    ├── 验证生成内容质量
    └── 返回HTML格式的文章内容
    ↓
第二步：生成文章摘要
    ↓
GeminiService.generate_digest(title, content, model)
    ├── 基于标题和内容生成摘要提示词
    ├── 要求：60-120字，吸引人的描述
    ├── 调用Gemini API生成摘要
    └── 返回摘要文本
```

### 3.4 配图生成阶段
```
第三步：确定配图策略
    ↓
根据文章长度计算配图数量
    ├── <1000字：1张配图
    ├── 1000-2000字：2张配图
    └── >2000字：3张配图
    ↓
第四步：生成配图
    ↓
ImageService.generate_article_image(title, content)
    ├── 创建cache目录下的临时文件
    ├── 构造图像生成提示词
    │   ├── 基于文章标题和内容
    │   ├── 要求：专业、简洁、相关性强
    │   └── 风格：现代、清晰、适合公众号
    ├── 调用Gemini的图像生成API
    │   ├── 使用image_model配置
    │   ├── 设置响应模式为 TEXT+IMAGE
    │   └── 处理生成的图像数据
    ├── 保存图像到本地文件
    └── 返回图像文件路径
```

### 3.5 内容整合阶段
```
第五步：内容格式化和整合
    ↓
整合所有生成的内容
    ├── 文章主体内容 (HTML格式)
    ├── 文章摘要
    ├── 配图文件路径列表
    ├── 元数据 (标题、作者、时间等)
    └── 生成统计信息
    ↓
构造返回数据结构
    ├── success: true
    ├── message: "文章生成成功"
    ├── data:
    │   ├── title: 文章标题
    │   ├── content: HTML内容
    │   ├── digest: 文章摘要
    │   ├── author: 作者信息
    │   ├── images: 配图路径数组
    │   ├── word_count: 字数统计
    │   ├── image_count: 配图数量
    │   └── generated_at: 生成时间
    └── 返回给前端
```

## 4. 前端处理和展示流程

### 4.1 生成结果处理
```
前端接收生成结果
    ↓
ArticleGenerator.showGenerationResult(data)
    ├── 隐藏生成进度界面
    ├── 显示生成结果卡片
    ├── 更新统计信息显示
    └── 添加到历史记录列表
    ↓
ArticlePreview.showPreview(data)
    ├── 在预览区域显示文章内容
    ├── 渲染HTML格式的文章正文
    ├── 显示配图（如果存在）
    ├── 显示文章元数据
    └── 提供编辑和发布操作按钮
```

### 4.2 用户交互功能
```
文章预览界面提供的功能：
    ├── 内容编辑：直接编辑生成的文章内容
    ├── 发布到微信：调用微信草稿API
    ├── 重新生成：使用相同标题重新生成
    ├── 保存草稿：本地保存草稿内容
    └── 分享链接：生成文章分享链接
```

## 5. 微信草稿发布流程

### 5.1 草稿创建流程
```
用户点击"发布到微信"
    ↓
前端发送草稿创建请求
    ↓
DraftService.create_draft()
    ├── 验证微信access_token有效性
    ├── 如果token过期，自动刷新
    ├── 构造微信草稿数据结构
    │   ├── title: 文章标题
    │   ├── content: HTML内容
    │   ├── digest: 文章摘要
    │   ├── author: 作者信息
    │   ├── content_source_url: 原文链接
    │   └── thumb_media_id: 封面图片ID
    ├── 调用微信草稿添加API
    ├── 处理微信API响应
    └── 返回草稿创建结果
```

### 5.2 素材上传流程
```
如果文章包含图片
    ↓
WeChatService.upload_media()
    ├── 读取本地图片文件
    ├── 构造文件上传请求
    ├── 调用微信临时素材上传API
    ├── 获取media_id
    └── 在文章内容中替换图片链接
```

## 6. 错误处理和日志记录

### 6.1 错误处理机制
```
每个服务层都包含完整的错误处理：
    ├── API调用失败处理
    ├── 网络连接异常处理
    ├── 数据格式验证
    ├── 权限验证失败处理
    └── 资源不足处理 (磁盘空间、内存等)
```

### 6.2 日志记录系统
```
应用日志记录结构：
    ├── 请求日志：记录所有HTTP请求
    ├── 操作日志：记录用户关键操作
    ├── 错误日志：记录所有异常和错误
    ├── 调试日志：记录API调用详情
    └── 性能日志：记录处理时间和资源使用
```

## 7. 配置管理和持久化

### 7.1 配置文件结构
```json
{
  "wechat_appid": "微信公众号AppID",
  "wechat_appsecret": "微信公众号AppSecret", 
  "gemini_api_key": "Google Gemini API密钥",
  "gemini_model": "AI模型名称",
  "author": "文章作者",
  "content_source_url": "内容源链接",
  "created_at": "配置创建时间",
  "updated_at": "配置更新时间"
}
```

### 7.2 配置安全性
```
配置文件安全措施：
    ├── 文件权限控制 (仅应用可读写)
    ├── 敏感信息不记录到日志
    ├── API密钥验证
    └── 配置备份和恢复机制
```

## 8. 系统监控和维护

### 8.1 健康检查
```
系统提供的监控端点：
    ├── /api/config - 配置状态检查
    ├── /api/test-wechat - 微信API连接状态
    ├── /api/test-gemini - AI服务连接状态
    └── 日志文件大小和轮转监控
```

### 8.2 性能优化
```
系统性能优化措施：
    ├── 缓存机制：临时文件和API响应缓存
    ├── 异步处理：长时间操作异步化
    ├── 资源清理：定期清理缓存和临时文件
    └── 请求限制：API调用频率限制
```

这个详细的工作流程文档涵盖了从系统启动到文章发布的完整过程，包括每个组件的职责、数据流向、错误处理和系统维护等方面。
